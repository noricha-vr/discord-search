# Bot コマンド設計

## コマンド一覧

| コマンド | 説明 |
|----------|------|
| `/search {query}` | 自然言語で検索 |
| `/sync` | 手動同期（管理者用） |

## /search

### 構文

```
/search {自然言語クエリ}
```

### 特徴

- オプション構文なし、すべて自然言語で指定
- LLM が柔軟に解釈して検索条件を生成

### 使用例

```
/search 先月の経理の話

/search 妻が送った見積書

/search 添付ファイルがあるメッセージで予算について

/search 12月に話したプロジェクトの進捗
```

### レスポンス形式

```
━━━━━━━━━━━━━━━━━━━━
🔍 5件見つかりました

1. 2024/12/15 #経理
   「請求書の処理について確認したいんだけど...」
   [ジャンプ]

2. 2024/12/10 #general
   「経費精算の件だけど、来週までに...」
   [ジャンプ]

3. 2024/12/08 #経理
   「来月の予算について相談があります...」
   [ジャンプ]

4. 2024/12/05 #projects
   「経理システムの更新について...」
   [ジャンプ]

5. 2024/12/01 #general
   「経理関連のタスクをまとめました...」
   [ジャンプ]

━━━━━━━━━━━━━━━━━━━━
💡 追加で条件を絞りますか？
   例: 「この中で添付ファイルがあるもの」
       「12月10日以降に絞って」
       「妻の発言だけ」
━━━━━━━━━━━━━━━━━━━━
```

### 検索結果が0件の場合

```
━━━━━━━━━━━━━━━━━━━━
🔍 該当するメッセージが見つかりませんでした

💡 検索のヒント:
   - 別のキーワードで試してみてください
   - 期間を広げてみてください
━━━━━━━━━━━━━━━━━━━━
```

## /sync

### 構文

```
/sync
```

### 説明

- 手動でメッセージ同期を実行
- 管理者用コマンド
- 通常は Cloud Scheduler で1時間ごとに自動実行

### レスポンス形式

```
━━━━━━━━━━━━━━━━━━━━
🔄 同期を開始しました...

✅ 同期完了
   - 新規メッセージ: 42件
   - 更新: 3件
   - 所要時間: 15秒
━━━━━━━━━━━━━━━━━━━━
```

## 絞り込みフロー

```
ユーザー: /search 経理の話
   ↓
Bot: 5件表示 + 「追加で条件を絞りますか？」
   ↓
ユーザー: 妻の発言だけ
   ↓
Bot: 絞り込み結果を表示 + 「追加で条件を絞りますか？」
   ↓
ユーザー: （満足したら終了）
```

## 内部処理

1. ユーザーの自然言語クエリを受け取る
2. Gemini File Search Tool でセマンティック検索
3. 結果を整形して Embed で返信
4. 追加絞り込みの提案を表示
5. ユーザーが続けて発言したら、前回の検索コンテキストを保持して絞り込み
